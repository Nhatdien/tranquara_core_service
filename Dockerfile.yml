FROM golang:1.23-alpine AS builder 

WORKDIR /build

COPY go.mod go.sum ./
RUN go mod download

COPY . .

ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64
RUN go build -ldflags="-s -w" -o main ./cmd/api

FROM alpine:latest

# Install necessary tools for wait-for-it script, healthcheck, and SSL certificates
RUN apk --no-cache add ca-certificates netcat-openbsd wget

WORKDIR /app

COPY --from=builder /build/main /app/
COPY --from=builder /build/publicKey.pem /app/
COPY wait-for-it.sh /app/

RUN chmod +x /app/wait-for-it.sh

ENTRYPOINT ["/app/wait-for-it.sh", "db:5432", "--", "/app/main"]